box: trenpixster/elixir

build:
  steps:
    # Get dependencies and compile
    - script:
        name: mix deps get compile
        code: |
          cd $WERCKER_SOURCE_DIR
          mix do deps.get, compile

    # Run tests
    - script:
        name: mix test
        code: |
          mix test

    # Push to Docker
    - internal/docker-push:
        username: $DOCKER_USER
        password: $DOCKER_PSWD
        tag: ${WERCKER_GIT_COMMIT}.${WERCKER_GIT_BRANCH}
        repo: $DOCKER_REPO
        registry: $DOCKER_REGISTRY

    # Save artifact
    - script:
        name: add to repo
        code: |
          cp -R ./ ${WERCKER_OUTPUT_DIR}

deploy:
  steps:
    - heroku-deploy:
        key-name: HEROKU_DEPLOY_KEY
        install-toolbelt: true